<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RollCall</title>
    <base href="/" />

    <!-- Bootstrap and custom CSS -->
    <link rel="stylesheet" href="css/bootstrap/bootstrap.min.css" />
    <link rel="stylesheet" href="css/app.css" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <link href="RollCall.styles.css" rel="stylesheet" />

    <!-- Firebase Configuration Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>

    <!-- jQuery and Bootstrap JavaScript -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

    <script>
        // Firebase configuration object
        const firebaseConfig = {
            apiKey: "AIzaSyDFzfBDWVd-H6dIADQUmmxiRt3Tu5zEw80",
            authDomain: "rollcall-4f68e.firebaseapp.com",
            databaseURL: "https://rollcall-4f68e-default-rtdb.firebaseio.com",
            projectId: "rollcall-4f68e",
            storageBucket: "rollcall-4f68e.appspot.com",
            messagingSenderId: "968520920745",
            appId: "1:968520920745:web:73411f874a1b9f1ce343b8",
            measurementId: "G-RP81FY5G3D"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        /**
         * Function to handle Google login.
         * Restricts login to users with URI.edu domain.
         */
        async function loginWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({
                'hd': 'uri.edu', // Restrict to URI.edu domain
                'prompt': 'select_account'
            });

            try {
                const result = await auth.signInWithPopup(provider);
                const user = result.user;
                const emailDomain = user.email.split('@')[1];

                // Check if the email domain is uri.edu
                if (emailDomain !== 'uri.edu') {
                    await auth.signOut();
                    alert('Only URI.edu emails are allowed.');
                } else {
                    await saveUserData(user);
                    window.location.href = "/classes"; // Redirect to classes page on successful login
                }
            } catch (error) {
                console.error("Sign in error:", error);
                alert("Sign in failed. Please try again.");
            }
        }

        /**
         * Function to save user data to Firebase.
         * @param {object} user - The authenticated user object.
         */
        async function saveUserData(user) {
            const userRef = database.ref('users/' + user.uid);
            const snapshot = await userRef.once('value');

            // Check if user data exists
            if (snapshot.exists()) {
                const existingData = snapshot.val();

                // Update only missing fields without modifying existing instructor value
                await userRef.update({
                    firstName: existingData.firstName || user.displayName.split(' ')[0],
                    lastName: existingData.lastName || user.displayName.split(' ').slice(1).join(' '),
                    email: existingData.email || user.email
                    // Do not update the instructor field
                });
            } else {
                // Set new user data
                await userRef.set({
                    firstName: user.displayName.split(' ')[0],
                    lastName: user.displayName.split(' ').slice(1).join(' '),
                    email: user.email,
                    instructor: false // Default role set to false
                });
            }
        }
        /**
         * Function to get current user data.
         * @returns {object|null} - The user data object or null if not authenticated.
         */
        function getUserData() {
            const user = firebase.auth().currentUser;
            if (user) {
                return {
                    displayName: user.displayName,
                    email: user.email,
                    instructor: user.instructor
                };
            }
            return null;
        }

        /**
         * Function to handle user logout.
         */
        async function logout() {
            try {
                await auth.signOut();
                console.log("User signed out.");
            } catch (error) {
                console.error("Sign out error:", error);
                alert("Sign out failed. Please try again.");
            }
        }

        /**
         * Function to check if the user is authenticated.
         * @returns {boolean} - True if the user is authenticated, otherwise false.
         */
        function isUserAuthenticated() {
            return !!auth.currentUser;
        }

        /**
         * Function to toggle collapse for elements with the specified class name.
         * @param {string} className - The class name of the element to toggle.
         */
        function toggleCollapse(className) {
            const element = document.getElementById(className);
            if (element) {
                $(element).collapse('toggle');
            }
        }

        // Expose functions to the global scope for accessibility
        window.loginWithGoogle = loginWithGoogle;
        window.logout = logout;
        window.isUserAuthenticated = isUserAuthenticated;
        window.saveUserData = saveUserData;
        window.getUserData = getUserData;
    </script>
</head>
<body>
    <div id="app">
        <!-- Loading spinner while the app is initializing -->
        <svg class="loading-progress">
            <circle r="40%" cx="50%" cy="50%" />
            <circle r="40%" cx="50%" cy="50%" />
        </svg>
        <div class="loading-progress-text"></div>
    </div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">ðŸ—™</a>
    </div>
    <!-- Blazor WebAssembly JavaScript -->
    <script src="_framework/blazor.webassembly.js"></script>
</body>
</html>

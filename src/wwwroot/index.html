<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RollCall</title>
    <base href="/" />
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/app.css" />
    <link href="RollCall.styles.css" rel="stylesheet" />

    <!-- Firebase Configuration -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>

    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDFzfBDWVd-H6dIADQUmmxiRt3Tu5zEw80",
            authDomain: "rollcall-4f68e.firebaseapp.com",
            databaseURL: "https://rollcall-4f68e-default-rtdb.firebaseio.com",
            projectId: "rollcall-4f68e",
            storageBucket: "rollcall-4f68e.appspot.com",
            messagingSenderId: "968520920745",
            appId: "1:968520920745:web:73411f874a1b9f1ce343b8",
            measurementId: "G-RP81FY5G3D"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        async function loginWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                await auth.signInWithRedirect(provider);
            } catch (error) {
                console.error("Sign in error:", error);
                throw new Error(error.message);
            }
        }

        async function saveUserData(user) {
            const userRef = database.ref('users/' + user.uid);
            await userRef.set({
                firstName: user.displayName.split(' ')[0],
                lastName: user.displayName.split(' ').slice(1).join(' '),
                email: user.email
            });
        }

        function clearCookies() {
            // Function to clear cookies
            document.cookie.split(";").forEach(function (c) {
                document.cookie = c.trim().split("=")[0] + "=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/";
            });
        }

        async function logout() {
            try {
                await auth.signOut();
                clearCookies();
                console.log("User signed out.");
                // Redirect to home page after logout
                window.location.href = "/";
            } catch (error) {
                console.error("Sign out error:", error);
                throw new Error(error.message);
            }
        }

        function onFirebaseAuthStateChanged(callback) {
            return auth.onAuthStateChanged(user => {
                DotNet.invokeMethodAsync('RollCall', 'OnAuthStateChanged', !!user);
            });
        }

        function isUserAuthenticated() {
            return !!auth.currentUser;
        }

        // Expose functions to the global scope
        window.loginWithGoogle = loginWithGoogle;
        window.logout = logout;
        window.onFirebaseAuthStateChanged = onFirebaseAuthStateChanged;
        window.isUserAuthenticated = isUserAuthenticated;
        window.saveUserData = saveUserData;
    </script>
</head>

<body>
    <div id="app">
        <svg class="loading-progress">
            <circle r="40%" cx="50%" cy="50%" />
            <circle r="40%" cx="50%" cy="50%" />
        </svg>
        <div class="loading-progress-text"></div>
    </div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">ðŸ—™</a>
    </div>

    <script src="_framework/blazor.webassembly.js"></script>
</body>

</html>

@page "/classes/create"
@using System.ComponentModel.DataAnnotations
@using Firebase.Database
@using Firebase.Database.Query
@using System.Text.Json
@using System.Text
@inject IJSRuntime JSRuntime
@inject IConfiguration Configuration
@inject NavigationManager Navigation

<PageTitle>Create Class</PageTitle>

<h3>Create Class</h3>

<!-- Form to create a new class -->
<EditForm Model="@classModel" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <!-- Class Name input field -->
    <div>
        <label>Class Name:</label>
        <InputText @bind-Value="classModel.ClassName" />
    </div>

    <!-- Days of the week checkboxes -->
    <div>
        <label>What days does the class meet?</label>
        <div>
            <InputCheckbox @bind-Value="classModel.Monday" />
            <label>Monday</label>
        </div>
        <div>
            <InputCheckbox @bind-Value="classModel.Tuesday" />
            <label>Tuesday</label>
        </div>
        <div>
            <InputCheckbox @bind-Value="classModel.Wednesday" />
            <label>Wednesday</label>
        </div>
        <div>
            <InputCheckbox @bind-Value="classModel.Thursday" />
            <label>Thursday</label>
        </div>
        <div>
            <InputCheckbox @bind-Value="classModel.Friday" />
            <label>Friday</label>
        </div>
    </div>

    <!-- Class Start Time input field -->
    <div>
        <label>Class Start Time:</label>
        <InputText @bind-Value="classModel.ClassStartTime" type="time" />
    </div>

    <!-- Class End Time input field -->
    <div>
        <label>Class End Time:</label>
        <InputText @bind-Value="classModel.ClassEndTime" type="time" />
    </div>

    <!-- Class End Date input field -->
    <div>
        <label>Class End Date:</label>
        <InputDate @bind-Value="classModel.ClassEndDate" />
    </div>

    <!-- Late Minutes input field -->
    <div>
        <label>How many minutes is considered late?</label>
        <InputNumber @bind-Value="classModel.LateMinutes" />
    </div>

    <!-- Absent Minutes input field -->
    <div>
        <label>How many minutes is considered absent?</label>
        <InputNumber @bind-Value="classModel.AbsentMinutes" />
    </div>

    <!-- Location input field and button -->
    <div>
        <label>Set Location:</label>
        <InputText @bind-Value="classModel.Location" />
        <button type="button" @onclick="SetLocation">Set Location</button>
    </div>

    <!-- Check-In Distance input field -->
    <div>
        <label>In feet how far should students be able to check in from where you are?</label>
        <InputNumber @bind-Value="classModel.CheckInDistance" />
    </div>

    <!-- Submit button -->
    <button type="submit">Submit</button>
</EditForm>

<!-- Display error message if any -->
@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

@code {
    public class UserData
    {
        public string Email { get; set; } = string.Empty;
    }

    private string creatorEmail = string.Empty;

    public class ClassModel
    {
        [Required]
        public string ClassName { get; set; } = string.Empty;
        public bool Monday { get; set; }
        public bool Tuesday { get; set; }
        public bool Wednesday { get; set; }
        public bool Thursday { get; set; }
        public bool Friday { get; set; }
        [Required]
        public string ClassStartTime { get; set; } = string.Empty;
        [Required]
        public string ClassEndTime { get; set; } = string.Empty;
        [Required]
        public DateTime ClassEndDate { get; set; } = DateTime.Now;
        [Required]
        public int LateMinutes { get; set; } = 0;
        [Required]
        public int AbsentMinutes { get; set; } = 0;
        [Required]
        public string Location { get; set; } = string.Empty;
        [Required]
        public int CheckInDistance { get; set; } = 0;
    }

    public class ClassData
    {
        public string ClassName { get; set; } = string.Empty;
        public List<string> SelectedDays { get; set; } = new List<string>();
        public string ClassStartTime { get; set; } = string.Empty;
        public string ClassEndTime { get; set; } = string.Empty;
        public string ClassEndDate { get; set; } = string.Empty;
        public int LateMinutes { get; set; } = 0;
        public int AbsentMinutes { get; set; } = 0;
        public string Location { get; set; } = string.Empty;
        public int CheckInDistance { get; set; } = 0;
        public string CreatorEmail { get; set; } = string.Empty;
    }

    private ClassModel classModel = new ClassModel();
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var userData = await JSRuntime.InvokeAsync<UserData>("getUserData");
        if (userData != null)
        {
            creatorEmail = userData.Email;
            StateHasChanged();
        }
    }

    private async Task<string> CallGoogleAppsScript(string className, string creatorEmail, List<string> selectedDays, DateTime classEndDate)
    {
        var scriptUrl = "https://script.google.com/macros/s/1Tiq3AfPxKIsq48FjUhLuJ3IuN-cC4Igb1-nDrI5bdOgws-1VUZ-V-5fC/exec";
        var payload = new
        {
            className,
            creatorEmail,
            selectedDays,
            classEndDate = classEndDate.ToString("yyyy-MM-dd")
        };

        var jsonPayload = JsonSerializer.Serialize(payload);
        var content = new StringContent(jsonPayload, Encoding.UTF8, "application/json");

        using var httpClient = new HttpClient();
        var response = await httpClient.PostAsync(scriptUrl, content);
        var responseBody = await response.Content.ReadAsStringAsync();

        return responseBody;
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            if (Configuration == null)
            {
                throw new Exception("Configuration is null");
            }

            string databaseUrl = "https://rollcall-4f68e-default-rtdb.firebaseio.com";
            if (string.IsNullOrEmpty(databaseUrl))
            {
                throw new Exception("Firebase:DatabaseUrl is null or empty");
            }

            var startTime = TimeSpan.Parse(classModel.ClassStartTime);
            var endTime = TimeSpan.Parse(classModel.ClassEndTime);

            var firebaseClient = new FirebaseClient(databaseUrl);
            var uid = Guid.NewGuid().ToString();

            var selectedDays = new List<string>();
            if (classModel.Monday) selectedDays.Add("Monday");
            if (classModel.Tuesday) selectedDays.Add("Tuesday");
            if (classModel.Wednesday) selectedDays.Add("Wednesday");
            if (classModel.Thursday) selectedDays.Add("Thursday");
            if (classModel.Friday) selectedDays.Add("Friday");

            var classData = new ClassData
                {
                    ClassName = classModel.ClassName,
                    SelectedDays = selectedDays,
                    ClassStartTime = startTime.ToString(@"hh\:mm"),
                    ClassEndTime = endTime.ToString(@"hh\:mm"),
                    ClassEndDate = classModel.ClassEndDate.ToString("yyyy-MM-dd"),
                    LateMinutes = classModel.LateMinutes,
                    AbsentMinutes = classModel.AbsentMinutes,
                    Location = classModel.Location,
                    CheckInDistance = classModel.CheckInDistance,
                    CreatorEmail = creatorEmail
                };

            // Save class data to Firebase
            await firebaseClient
                .Child("classes")
                .Child(uid)
                .PutAsync(classData);

            // Call Google Apps Script to create and populate the sheet
            var sheetUrl = await CallGoogleAppsScript(
                classModel.ClassName,
                creatorEmail,
                selectedDays,
                classModel.ClassEndDate
            );

            // Optionally, save the Google Sheet URL to Firebase
            await firebaseClient
                .Child("classes")
                .Child(uid)
                .Child("sheetUrl")
                .PutAsync(sheetUrl);

            Console.WriteLine("Class successfully created and pushed to Firebase.");
            Navigation.NavigateTo("/classes");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
    }

    private void SetLocation()
    {
        Console.WriteLine("Location set.");
    }
}
